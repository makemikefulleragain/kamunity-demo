"use strict";(()=>{var e={};e.id=429,e.ids=[429],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8977:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>f,patchFetch:()=>g,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>y});var r={};i.r(r),i.d(r,{GET:()=>d,POST:()=>u});var o=i(9303),a=i(8716),s=i(3131),c=i(7070),n=i(9660);async function d(e,{params:t}){try{let{id:i}=t,{searchParams:r}=new URL(e.url);if(!i)return c.NextResponse.json({success:!1,error:"Action ID is required"},{status:400});let o=parseInt(r.get("limit")||"20"),a=await (0,n.TA)(i,o);return c.NextResponse.json({success:!0,data:a})}catch(e){return console.error("Error in GET /api/actions/[id]/activities:",e),c.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to fetch action activities"},{status:500})}}async function u(e,{params:t}){try{let{id:i}=t,r=await e.json();if(!i)return c.NextResponse.json({success:!1,error:"Action ID is required"},{status:400});for(let e of["userId","activityType","description"])if(!r[e])return c.NextResponse.json({success:!1,error:`Missing required field: ${e}`},{status:400});if(!["created","assigned","status_changed","commented","completed"].includes(r.activityType))return c.NextResponse.json({success:!1,error:"Invalid activityType"},{status:400});let o=await (0,n.qv)({actionId:i,userId:r.userId,activityType:r.activityType,description:r.description,metadata:r.metadata});return c.NextResponse.json({success:!0,data:o},{status:201})}catch(e){return console.error("Error in POST /api/actions/[id]/activities:",e),c.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to create action activity"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/actions/[id]/activities/route",pathname:"/api/actions/[id]/activities",filename:"route",bundlePath:"app/api/actions/[id]/activities/route"},resolvedPagePath:"C:\\dev\\kamunity-final\\src\\app\\api\\actions\\[id]\\activities\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:y,serverHooks:m}=l,f="/api/actions/[id]/activities/route";function g(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:y})}},9660:(e,t,i)=>{i.d(t,{Aq:()=>p,Gx:()=>c,Jj:()=>l,PH:()=>o,Sv:()=>s,TA:()=>u,Tg:()=>f,gF:()=>m,hl:()=>a,mn:()=>n,qv:()=>d,zS:()=>y});let r=new(i(3524)).PrismaClient;async function o(e){try{let t=await r.action.create({data:{title:e.title,description:e.description,actionType:e.actionType,impactLevel:e.impactLevel,sourceType:e.sourceType,status:e.status,priority:e.priority||"medium",createdBy:e.createdBy,assignedTo:e.assignedTo||[],volunteers:e.volunteers||[],ownershipType:e.ownershipType,isPublic:e.isPublic||!1,promotedFromPrivate:e.promotedFromPrivate||!1,sourceId:e.sourceId,sourceMessageId:e.sourceMessageId,detectionMethod:e.detectionMethod,isConfirmed:e.isConfirmed||!1,dueDate:e.dueDate,estimatedEffort:e.estimatedEffort,requiredSkills:e.requiredSkills||[],tags:e.tags||[],focusRoomId:e.focusRoomId,statusConfig:e.statusConfig},include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"}},focusRoom:!0}});return await d({actionId:t.id,userId:e.createdBy,activityType:"created",description:`Action "${e.title}" was created`,metadata:{initialStatus:e.status,detectionMethod:e.detectionMethod}}),t}catch(e){throw console.error("Error creating action:",e),Error("Failed to create action")}}async function a(e){try{return await r.action.findUnique({where:{id:e},include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"}},focusRoom:!0}})}catch(e){throw console.error("Error fetching action:",e),Error("Failed to fetch action")}}async function s(e={},t={field:"createdAt",direction:"desc"},i=50,o=0){try{let a={};e.actionType?.length&&(a.actionType={in:e.actionType}),e.impactLevel?.length&&(a.impactLevel={in:e.impactLevel}),e.sourceType?.length&&(a.sourceType={in:e.sourceType}),e.status?.length&&(a.status={in:e.status}),e.priority?.length&&(a.priority={in:e.priority}),void 0!==e.isPublic&&(a.isPublic=e.isPublic),e.assignedToMe&&(a.assignedTo={has:e.assignedToMe}),e.createdByMe&&(a.createdBy=e.createdByMe),(e.dueDate?.from||e.dueDate?.to)&&(a.dueDate={},e.dueDate.from&&(a.dueDate.gte=e.dueDate.from),e.dueDate.to&&(a.dueDate.lte=e.dueDate.to)),e.tags?.length&&(a.tags={hasSome:e.tags}),e.searchQuery&&(a.OR=[{title:{contains:e.searchQuery,mode:"insensitive"}},{description:{contains:e.searchQuery,mode:"insensitive"}}]);let s={};s[t.field]=t.direction;let[c,n]=await Promise.all([r.action.findMany({where:a,include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"},take:3},focusRoom:!0},orderBy:s,take:i,skip:o}),r.action.count({where:a})]);return{actions:c,total:n}}catch(e){throw console.error("Error fetching actions:",e),Error("Failed to fetch actions")}}async function c(e,t,i){try{let o=await r.action.findUnique({where:{id:e}});if(!o)throw Error("Action not found");let a=await r.action.update({where:{id:e},data:{...t,updatedAt:new Date},include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"}},focusRoom:!0}});return t.status&&t.status!==o.status&&await d({actionId:e,userId:i,activityType:"status_changed",description:`Status changed from "${o.status}" to "${t.status}"`,metadata:{previousStatus:o.status,newStatus:t.status}}),t.assignedTo&&JSON.stringify(t.assignedTo)!==JSON.stringify(o.assignedTo)&&await d({actionId:e,userId:i,activityType:"assigned",description:"Assignment updated",metadata:{previousAssignees:o.assignedTo,newAssignees:t.assignedTo}}),a}catch(e){throw console.error("Error updating action:",e),Error("Failed to update action")}}async function n(e){try{await r.action.delete({where:{id:e}})}catch(e){throw console.error("Error deleting action:",e),Error("Failed to delete action")}}async function d(e){try{return await r.actionActivity.create({data:{actionId:e.actionId,userId:e.userId,activityType:e.activityType,description:e.description,metadata:e.metadata},include:{user:!0,action:!0}})}catch(e){throw console.error("Error creating action activity:",e),Error("Failed to create action activity")}}async function u(e,t=20){try{return await r.actionActivity.findMany({where:{actionId:e},include:{user:!0},orderBy:{createdAt:"desc"},take:t})}catch(e){throw console.error("Error fetching action activities:",e),Error("Failed to fetch action activities")}}async function l(e,t,i,r){let o=[],a=[/(?:by|due|deadline)\s+([a-zA-Z]+ \d{1,2})/gi,/(?:next|this)\s+(week|month|friday|monday|tuesday|wednesday|thursday|saturday|sunday)/gi],s=[/(\d+)\s+(hour|hours|day|days|week|weeks)/gi,/(quick|fast|simple|complex|difficult)/gi];for(let{pattern:t,type:i,confidence:r}of[{pattern:/(?:need to|should|must|let's|we should)\s+([^.!?]+)/gi,type:"task",confidence:.7},{pattern:/(?:meeting|event|gathering|workshop)\s+([^.!?]+)/gi,type:"event",confidence:.8},{pattern:/(?:propose|suggest|idea)\s+([^.!?]+)/gi,type:"proposal",confidence:.6},{pattern:/(?:need help|looking for|seeking)\s+([^.!?]+)/gi,type:"resource_needed",confidence:.8}]){let c;for(;null!==(c=t.exec(e));){let t=c[1].trim();if(t.length>10){let c,n;for(let t of a){let i=t.exec(e);if(i){i[1];break}}for(let t of s){let i=t.exec(e);if(i){n=i[0];break}}let d="individual";e.includes("community")||e.includes("everyone")||e.includes("all")?d="community":e.includes("neighborhood")||e.includes("local")?d="local":(e.includes("system")||e.includes("policy")||e.includes("government"))&&(d="systemic"),o.push({confidence:r,suggestedTitle:t.length>50?t.substring(0,50)+"...":t,suggestedDescription:t,suggestedType:i,suggestedImpactLevel:d,extractedMetadata:{dueDate:c,estimatedEffort:n,requiredSkills:[],tags:[]}})}}}return o}async function p(e,t){try{let i=await c(e,{isPublic:!0,promotedFromPrivate:!0},t);return await d({actionId:e,userId:t,activityType:"status_changed",description:"Action promoted to public visibility",metadata:{promotionType:"private_to_public"}}),i}catch(e){throw console.error("Error promoting action:",e),Error("Failed to promote action")}}async function y(e,t,i=!1){try{let o={sourceType:e,sourceId:t};return i||(o.isPublic=!0),await r.action.findMany({where:o,include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"},take:3},focusRoom:!0},orderBy:{createdAt:"desc"}})}catch(e){throw console.error("Error fetching actions by source:",e),Error("Failed to fetch actions by source")}}async function m(e,t=!0,i=!0){try{let o=[];return i&&o.push({createdBy:e}),t&&o.push({assignedTo:{has:e}}),await r.action.findMany({where:{OR:o},include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"},take:3},focusRoom:!0},orderBy:{updatedAt:"desc"}})}catch(e){throw console.error("Error fetching user actions:",e),Error("Failed to fetch user actions")}}async function f(e={}){try{let t={};e.sourceType?.length&&(t.sourceType={in:e.sourceType}),void 0!==e.isPublic&&(t.isPublic=e.isPublic);let[i,o,a,s,c,n]=await Promise.all([r.action.count({where:t}),r.action.groupBy({by:["actionType"],where:t,_count:{actionType:!0}}),r.action.groupBy({by:["status"],where:t,_count:{status:!0}}),r.action.groupBy({by:["impactLevel"],where:t,_count:{impactLevel:!0}}),r.action.groupBy({by:["priority"],where:t,_count:{priority:!0}}),r.action.count({where:{...t,status:{in:["completed","impact_assessed"]}}})]);return{total:i,byType:Object.fromEntries(o.map(e=>[e.actionType,e._count.actionType])),byStatus:Object.fromEntries(a.map(e=>[e.status,e._count.status])),byImpactLevel:Object.fromEntries(s.map(e=>[e.impactLevel,e._count.impactLevel])),byPriority:Object.fromEntries(c.map(e=>[e.priority,e._count.priority])),completionRate:i>0?n/i*100:0}}catch(e){throw console.error("Error fetching action stats:",e),Error("Failed to fetch action stats")}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[948,972],()=>i(8977));module.exports=r})();
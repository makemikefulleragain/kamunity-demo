"use strict";(()=>{var e={};e.id=578,e.ids=[578],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4622:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>m,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>y});var r={};i.r(r),i.d(r,{GET:()=>u,POST:()=>d});var o=i(9303),s=i(8716),a=i(3131),n=i(7070),c=i(9660);async function u(e){try{let{searchParams:t}=new URL(e.url),i={};t.get("actionType")&&(i.actionType=t.get("actionType").split(",")),t.get("impactLevel")&&(i.impactLevel=t.get("impactLevel").split(",")),t.get("sourceType")&&(i.sourceType=t.get("sourceType").split(",")),t.get("status")&&(i.status=t.get("status").split(",")),t.get("priority")&&(i.priority=t.get("priority").split(",")),t.get("isPublic")&&(i.isPublic="true"===t.get("isPublic")),t.get("assignedToMe")&&(i.assignedToMe=t.get("assignedToMe")),t.get("createdByMe")&&(i.createdByMe=t.get("createdByMe")),t.get("tags")&&(i.tags=t.get("tags").split(",")),t.get("searchQuery")&&(i.searchQuery=t.get("searchQuery")),t.get("dueDateFrom")&&(i.dueDate={...i.dueDate,from:new Date(t.get("dueDateFrom"))}),t.get("dueDateTo")&&(i.dueDate={...i.dueDate,to:new Date(t.get("dueDateTo"))});let r={field:t.get("sortField")||"createdAt",direction:t.get("sortDirection")||"desc"},o=parseInt(t.get("limit")||"50"),s=parseInt(t.get("offset")||"0");if("true"===t.get("includeStats")){let[e,t]=await Promise.all([(0,c.Sv)(i,r,o,s),(0,c.Tg)(i)]);return n.NextResponse.json({success:!0,data:{...e,stats:t}})}let a=await (0,c.Sv)(i,r,o,s);return n.NextResponse.json({success:!0,data:a})}catch(e){return console.error("Error in GET /api/actions:",e),n.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to fetch actions"},{status:500})}}async function d(e){try{let t=await e.json();for(let e of["title","description","actionType","impactLevel","sourceType","status","createdBy","ownershipType","detectionMethod"])if(!t[e])return n.NextResponse.json({success:!1,error:`Missing required field: ${e}`},{status:400});if(!["task","event","initiative","proposal","resource_needed"].includes(t.actionType))return n.NextResponse.json({success:!1,error:"Invalid actionType"},{status:400});if(!["individual","local","community","systemic"].includes(t.impactLevel))return n.NextResponse.json({success:!1,error:"Invalid impactLevel"},{status:400});if(!["chat","focus_room","club","community"].includes(t.sourceType))return n.NextResponse.json({success:!1,error:"Invalid sourceType"},{status:400});if(t.priority&&!["low","medium","high","urgent"].includes(t.priority))return n.NextResponse.json({success:!1,error:"Invalid priority"},{status:400});if(!["self_assigned","leader_assigned","community_driven"].includes(t.ownershipType))return n.NextResponse.json({success:!1,error:"Invalid ownershipType"},{status:400});if(!["auto","manual","hybrid"].includes(t.detectionMethod))return n.NextResponse.json({success:!1,error:"Invalid detectionMethod"},{status:400});t.dueDate&&(t.dueDate=new Date(t.dueDate));let i=await (0,c.PH)(t);return n.NextResponse.json({success:!0,data:i},{status:201})}catch(e){return console.error("Error in POST /api/actions:",e),n.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to create action"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/actions/route",pathname:"/api/actions",filename:"route",bundlePath:"app/api/actions/route"},resolvedPagePath:"C:\\dev\\kamunity-final\\src\\app\\api\\actions\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:y,serverHooks:g}=l,m="/api/actions/route";function f(){return(0,a.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:y})}},9660:(e,t,i)=>{i.d(t,{Aq:()=>p,Gx:()=>n,Jj:()=>l,PH:()=>o,Sv:()=>a,TA:()=>d,Tg:()=>m,gF:()=>g,hl:()=>s,mn:()=>c,qv:()=>u,zS:()=>y});let r=new(i(3524)).PrismaClient;async function o(e){try{let t=await r.action.create({data:{title:e.title,description:e.description,actionType:e.actionType,impactLevel:e.impactLevel,sourceType:e.sourceType,status:e.status,priority:e.priority||"medium",createdBy:e.createdBy,assignedTo:e.assignedTo||[],volunteers:e.volunteers||[],ownershipType:e.ownershipType,isPublic:e.isPublic||!1,promotedFromPrivate:e.promotedFromPrivate||!1,sourceId:e.sourceId,sourceMessageId:e.sourceMessageId,detectionMethod:e.detectionMethod,isConfirmed:e.isConfirmed||!1,dueDate:e.dueDate,estimatedEffort:e.estimatedEffort,requiredSkills:e.requiredSkills||[],tags:e.tags||[],focusRoomId:e.focusRoomId,statusConfig:e.statusConfig},include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"}},focusRoom:!0}});return await u({actionId:t.id,userId:e.createdBy,activityType:"created",description:`Action "${e.title}" was created`,metadata:{initialStatus:e.status,detectionMethod:e.detectionMethod}}),t}catch(e){throw console.error("Error creating action:",e),Error("Failed to create action")}}async function s(e){try{return await r.action.findUnique({where:{id:e},include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"}},focusRoom:!0}})}catch(e){throw console.error("Error fetching action:",e),Error("Failed to fetch action")}}async function a(e={},t={field:"createdAt",direction:"desc"},i=50,o=0){try{let s={};e.actionType?.length&&(s.actionType={in:e.actionType}),e.impactLevel?.length&&(s.impactLevel={in:e.impactLevel}),e.sourceType?.length&&(s.sourceType={in:e.sourceType}),e.status?.length&&(s.status={in:e.status}),e.priority?.length&&(s.priority={in:e.priority}),void 0!==e.isPublic&&(s.isPublic=e.isPublic),e.assignedToMe&&(s.assignedTo={has:e.assignedToMe}),e.createdByMe&&(s.createdBy=e.createdByMe),(e.dueDate?.from||e.dueDate?.to)&&(s.dueDate={},e.dueDate.from&&(s.dueDate.gte=e.dueDate.from),e.dueDate.to&&(s.dueDate.lte=e.dueDate.to)),e.tags?.length&&(s.tags={hasSome:e.tags}),e.searchQuery&&(s.OR=[{title:{contains:e.searchQuery,mode:"insensitive"}},{description:{contains:e.searchQuery,mode:"insensitive"}}]);let a={};a[t.field]=t.direction;let[n,c]=await Promise.all([r.action.findMany({where:s,include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"},take:3},focusRoom:!0},orderBy:a,take:i,skip:o}),r.action.count({where:s})]);return{actions:n,total:c}}catch(e){throw console.error("Error fetching actions:",e),Error("Failed to fetch actions")}}async function n(e,t,i){try{let o=await r.action.findUnique({where:{id:e}});if(!o)throw Error("Action not found");let s=await r.action.update({where:{id:e},data:{...t,updatedAt:new Date},include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"}},focusRoom:!0}});return t.status&&t.status!==o.status&&await u({actionId:e,userId:i,activityType:"status_changed",description:`Status changed from "${o.status}" to "${t.status}"`,metadata:{previousStatus:o.status,newStatus:t.status}}),t.assignedTo&&JSON.stringify(t.assignedTo)!==JSON.stringify(o.assignedTo)&&await u({actionId:e,userId:i,activityType:"assigned",description:"Assignment updated",metadata:{previousAssignees:o.assignedTo,newAssignees:t.assignedTo}}),s}catch(e){throw console.error("Error updating action:",e),Error("Failed to update action")}}async function c(e){try{await r.action.delete({where:{id:e}})}catch(e){throw console.error("Error deleting action:",e),Error("Failed to delete action")}}async function u(e){try{return await r.actionActivity.create({data:{actionId:e.actionId,userId:e.userId,activityType:e.activityType,description:e.description,metadata:e.metadata},include:{user:!0,action:!0}})}catch(e){throw console.error("Error creating action activity:",e),Error("Failed to create action activity")}}async function d(e,t=20){try{return await r.actionActivity.findMany({where:{actionId:e},include:{user:!0},orderBy:{createdAt:"desc"},take:t})}catch(e){throw console.error("Error fetching action activities:",e),Error("Failed to fetch action activities")}}async function l(e,t,i,r){let o=[],s=[/(?:by|due|deadline)\s+([a-zA-Z]+ \d{1,2})/gi,/(?:next|this)\s+(week|month|friday|monday|tuesday|wednesday|thursday|saturday|sunday)/gi],a=[/(\d+)\s+(hour|hours|day|days|week|weeks)/gi,/(quick|fast|simple|complex|difficult)/gi];for(let{pattern:t,type:i,confidence:r}of[{pattern:/(?:need to|should|must|let's|we should)\s+([^.!?]+)/gi,type:"task",confidence:.7},{pattern:/(?:meeting|event|gathering|workshop)\s+([^.!?]+)/gi,type:"event",confidence:.8},{pattern:/(?:propose|suggest|idea)\s+([^.!?]+)/gi,type:"proposal",confidence:.6},{pattern:/(?:need help|looking for|seeking)\s+([^.!?]+)/gi,type:"resource_needed",confidence:.8}]){let n;for(;null!==(n=t.exec(e));){let t=n[1].trim();if(t.length>10){let n,c;for(let t of s){let i=t.exec(e);if(i){i[1];break}}for(let t of a){let i=t.exec(e);if(i){c=i[0];break}}let u="individual";e.includes("community")||e.includes("everyone")||e.includes("all")?u="community":e.includes("neighborhood")||e.includes("local")?u="local":(e.includes("system")||e.includes("policy")||e.includes("government"))&&(u="systemic"),o.push({confidence:r,suggestedTitle:t.length>50?t.substring(0,50)+"...":t,suggestedDescription:t,suggestedType:i,suggestedImpactLevel:u,extractedMetadata:{dueDate:n,estimatedEffort:c,requiredSkills:[],tags:[]}})}}}return o}async function p(e,t){try{let i=await n(e,{isPublic:!0,promotedFromPrivate:!0},t);return await u({actionId:e,userId:t,activityType:"status_changed",description:"Action promoted to public visibility",metadata:{promotionType:"private_to_public"}}),i}catch(e){throw console.error("Error promoting action:",e),Error("Failed to promote action")}}async function y(e,t,i=!1){try{let o={sourceType:e,sourceId:t};return i||(o.isPublic=!0),await r.action.findMany({where:o,include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"},take:3},focusRoom:!0},orderBy:{createdAt:"desc"}})}catch(e){throw console.error("Error fetching actions by source:",e),Error("Failed to fetch actions by source")}}async function g(e,t=!0,i=!0){try{let o=[];return i&&o.push({createdBy:e}),t&&o.push({assignedTo:{has:e}}),await r.action.findMany({where:{OR:o},include:{creator:!0,activities:{include:{user:!0},orderBy:{createdAt:"desc"},take:3},focusRoom:!0},orderBy:{updatedAt:"desc"}})}catch(e){throw console.error("Error fetching user actions:",e),Error("Failed to fetch user actions")}}async function m(e={}){try{let t={};e.sourceType?.length&&(t.sourceType={in:e.sourceType}),void 0!==e.isPublic&&(t.isPublic=e.isPublic);let[i,o,s,a,n,c]=await Promise.all([r.action.count({where:t}),r.action.groupBy({by:["actionType"],where:t,_count:{actionType:!0}}),r.action.groupBy({by:["status"],where:t,_count:{status:!0}}),r.action.groupBy({by:["impactLevel"],where:t,_count:{impactLevel:!0}}),r.action.groupBy({by:["priority"],where:t,_count:{priority:!0}}),r.action.count({where:{...t,status:{in:["completed","impact_assessed"]}}})]);return{total:i,byType:Object.fromEntries(o.map(e=>[e.actionType,e._count.actionType])),byStatus:Object.fromEntries(s.map(e=>[e.status,e._count.status])),byImpactLevel:Object.fromEntries(a.map(e=>[e.impactLevel,e._count.impactLevel])),byPriority:Object.fromEntries(n.map(e=>[e.priority,e._count.priority])),completionRate:i>0?c/i*100:0}}catch(e){throw console.error("Error fetching action stats:",e),Error("Failed to fetch action stats")}}}};var t=require("../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[948,972],()=>i(4622));module.exports=r})();